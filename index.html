<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Script Rehearsal Tool</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
  margin:0;
  padding:20px;
}
.container {
  max-width:1100px;
  margin:auto;
  background:white;
  border-radius:16px;
  overflow:hidden;
}
.header {
  padding:30px;
  text-align:center;
  color:white;
  background:linear-gradient(135deg,#667eea,#764ba2);
}
.content { padding:30px; }
.hidden { display:none; }

.upload {
  text-align:center;
  padding:40px;
  background:#f5f6fa;
  border-radius:12px;
}
button {
  padding:12px 24px;
  border-radius:8px;
  border:none;
  background:#667eea;
  color:white;
  cursor:pointer;
}
button:disabled { opacity:0.5; cursor:not-allowed; }

.voice-row {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-bottom:1px solid #eee;
}
select { padding:6px; }

.line {
  margin-top:20px;
  font-size:18px;
}
.character { font-weight:700; color:#667eea; }

.controls { margin-top:20px; text-align:center; }
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>ðŸŽ­ Script Rehearsal Tool</h1>
    <p>Upload JSON â†’ choose voices â†’ rehearse</p>
  </div>

  <div class="content">

    <!-- UPLOAD -->
    <div id="upload" class="upload">
      <input type="file" id="fileInput" accept=".json"/>
      <br><br>
      <button onclick="fileInput.click()">Choose script_data.json</button>
      <p id="fileStatus"></p>
    </div>

    <!-- VOICE PICKER -->
    <div id="voicePicker" class="hidden">
      <h2>Choose voices per character</h2>
      <div id="voiceList"></div>
      <div class="controls">
        <button onclick="start()">Start Rehearsal</button>
      </div>
    </div>

    <!-- REHEARSAL -->
    <div id="rehearsal" class="hidden">
      <div class="line">
        <div class="character" id="char"></div>
        <div id="text"></div>
      </div>
      <div class="controls">
        <button onclick="stop()">Stop</button>
      </div>
    </div>

  </div>
</div>

<script>
let scriptData;
let characters = [];
let voices = [];
let voiceMap = {};
let playing = false;
const synth = window.speechSynthesis;

function loadVoices() {
  voices = synth.getVoices();
}
loadVoices();
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = loadVoices;
}

/* ========= UPLOAD ========= */
fileInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    scriptData = JSON.parse(ev.target.result);
    extractCharacters();
    buildVoicePicker();
    upload.classList.add("hidden");
    voicePicker.classList.remove("hidden");
    fileStatus.textContent = "Loaded âœ”";
  };
  reader.readAsText(file);
};

/* ========= CHARACTERS ========= */
function extractCharacters() {
  const set = new Set();
  scriptData.scenes.forEach(s =>
    s.lines.forEach(l => l.character && set.add(l.character))
  );
  characters = [...set];
}

/* ========= VOICE PICKER ========= */
function buildVoicePicker() {
  voiceList.innerHTML = "";
  characters.forEach(c => {
    const row = document.createElement("div");
    row.className = "voice-row";

    const label = document.createElement("div");
    label.textContent = c;

    const select = document.createElement("select");
    voices.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      select.appendChild(opt);
    });

    voiceMap[c] = voices[0]?.name;
    select.onchange = e => voiceMap[c] = e.target.value;

    row.append(label, select);
    voiceList.appendChild(row);
  });
}

/* ========= REHEARSAL ========= */
async function start() {
  voicePicker.classList.add("hidden");
  rehearsal.classList.remove("hidden");
  playing = true;

  for (const scene of scriptData.scenes) {
    for (const line of scene.lines) {
      if (!playing) return;
      char.textContent = line.character;
      text.textContent = line.line;
      await speak(line.character, line.line);
    }
  }
}

function stop() {
  playing = false;
  synth.cancel();
}

function speak(character, textLine) {
  return new Promise(resolve => {
    const u = new SpeechSynthesisUtterance(textLine);
    const v = voices.find(v => v.name === voiceMap[character]);
    if (v) u.voice = v;
    u.onend = resolve;
    synth.speak(u);
  });
}
</script>
</body>
</html>
